<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>WebXR: AR Sem Marcador (3 Modelos)</title>

    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; }
        /* O botão de AR aparecerá automaticamente no canto inferior direito */
        #instrucao {
            position: fixed;
            top: 10px;
            width: 100%;
            text-align: center;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px;
            z-index: 99;
            font-family: sans-serif;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="instrucao">
        1. Clique no **ícone AR**. 2. Aponte para o chão. 3. Toque no ecrã para colocar o objeto. Toque na **esquerda/direita** para trocar de modelo.
    </div>

    <a-scene webxr="requiredFeatures: [hit-test, local-floor]; optionalFeatures: [dom-overlay]; overlay: #dom-overlay;">

        <a-assets>
            <a-asset-item id="modelo1" src="https://axbdc.github.io/testWebAR/ar-models/stitch_ar.glb"></a-asset-item>
            <a-asset-item id="modelo2" src="https://axbdc.github.io/testWebAR/ar-models/model2.glb"></a-asset-item>
            <a-asset-item id="modelo3" src="https://axbdc.github.io/testWebAR/ar-models/model3.glb"></a-asset-item>
        </a-assets>

        <a-camera position="0 0 0" wasd-controls="enabled: false">
            <a-entity cursor="fuse: false; rayOrigin: mouse"
                      raycaster="objects: [raycaster-target]; far: 50"
                      hit-test-viewer></a-entity>
        </a-camera>

    </a-scene>

    <script>
        // Lista de modelos a usar (usa os IDs definidos em a-assets)
        const modelos = [
            { id: "Stitch", assetId: "#modelo1" }, 
            { id: "Modelo 2", assetId: "#modelo2" },
            { id: "Modelo 3", assetId: "#modelo3" } 
        ];
        let indiceAtual = 0;
        
        // --- 4.1. COMPONENTE A-FRAME PARA RASTREIO E COLOCAÇÃO ---
        AFRAME.registerComponent('hit-test-viewer', {
            init: function() {
                const scene = this.el.sceneEl;
                const camera = this.el;
                let isAR = false;
                let currentModel = null;
                
                // Listener para a navegação por clique (após o AR ter começado)
                camera.addEventListener('click', (event) => {
                    if (isAR) {
                        // Se o clique não for na câmara, ignora.
                        if (event.target !== camera) return; 

                        const larguraEcra = window.innerWidth;
                        const posicaoX = event.clientX;
                        
                        // Determina se o toque foi na esquerda ou direita para trocar o modelo
                        if (posicaoX < larguraEcra / 2) {
                             indiceAtual = (indiceAtual - 1 + modelos.length) % modelos.length; // Anterior
                        } else {
                            indiceAtual = (indiceAtual + 1) % modelos.length; // Próximo
                        }

                        // Atualiza o modelo, se já existir um colocado
                        if (currentModel) {
                            currentModel.setAttribute('gltf-model', modelos[indiceAtual].assetId);
                            console.log("Modelo alterado para: " + modelos[indiceAtual].id);
                        }
                    }
                });

                // --- EVENTO DE INÍCIO AR ---
                scene.addEventListener('enter-vr', (event) => {
                    if (scene.is('ar-mode')) {
                        isAR = true;
                        
                        // Adiciona o listener para o toque na tela (que aciona o hit-test)
                        scene.addEventListener('ar-hit-test-event', (event) => {
                            // Se já existir um modelo, ou não houver colisão (hit), ignora.
                            if (!event.detail.hit || currentModel) return;

                            // Coloca o modelo no local de colisão (hit)
                            currentModel = document.createElement('a-entity');
                            
                            // Adiciona o primeiro modelo da lista
                            currentModel.setAttribute('gltf-model', modelos[indiceAtual].assetId);
                            currentModel.setAttribute('scale', '0.1 0.1 0.1'); // Escala inicial, ajuste se necessário
                            currentModel.setAttribute('shadow', 'receive: false');

                            scene.appendChild(currentModel);
                            
                            console.log("Modelo colocado no chão.");
                        });
                    }
                });
                
                // O WebXR fará o rastreamento, este evento pode ser usado para debug ou para mostrar um círculo no chão.
                scene.addEventListener('ar-hit-test-event', (event) => {
                    if (isAR && !currentModel && event.detail.hit) {
                        // (Lógica para mostrar um ponto de mira)
                    }
                });
            }
        });
        
    </script>
</body>
</html>
